<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SystÃ¨me de Prise en Charge</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        #sidebar { background: #2c2c2c; padding: 10px; border-bottom: 2px solid #e74c3c; z-index: 1000; }
        #map { flex-grow: 1; width: 100%; background: #222; }
        .status-badge { padding: 10px; border-radius: 4px; font-weight: bold; background: #27ae60; text-align: center; margin-top: 10px; }
        .danger-mode { background: #e74c3c !important; animation: pulse 1s infinite; border: 2px solid white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        button { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 4px; font-weight: bold; text-transform: uppercase; cursor: pointer; color: white; }
        #btn-vocal { background: #34495e; }
        #btn-vocal.on { background: #2ecc71; }
        #btn-signalement { background: #3498db; }
        #btn-signalement.active { background: #2ecc71; }
        #btn-prise-charge { background: #e67e22; }
        #btn-prise-charge.active { background: #c0392b; box-shadow: 0 0 15px #e74c3c; }
        #unit-id-input { width: 100%; padding: 8px; background: #444; border: 1px solid #666; color: white; box-sizing: border-box; }
        ul { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 80px; overflow-y: auto; font-size: 0.8rem; }
        li { padding: 4px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar">
        <input type="text" id="unit-id-input" placeholder="NOM DE L'UNITÃ‰">
        <div style="display: flex; gap: 5px;">
            <button id="btn-vocal">Micro : OFF</button>
            <button id="btn-signalement">S'AFFICHER</button>
        </div>
        <button id="btn-prise-charge">DÃ©marrer Prise en Charge</button>
        <div id="main-status" class="status-badge">ZONE SÃ‰CURISÃ‰E</div>
        <ul id="unit-list"></ul>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    // 1. CONFIGURATION
    const firebaseConfig = { databaseURL: "https://poursuite-tactique-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const idInput = document.getElementById('unit-id-input');
    let myId = localStorage.getItem('unit_name') || "UnitÃ©-" + Math.floor(Math.random() * 100);
    idInput.value = myId;

    const map = L.map('map').setView([48.8566, 2.3522], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const otherVehicles = {};
    let myCurrentPos = null;
    let isVisible = false;
    let isPEC = false;
    let myStream;

    const myMarker = L.marker([0, 0], { zIndexOffset: 2000 }).addTo(map).bindPopup("MOI");
    const statusBadge = document.getElementById('main-status');

    // 2. TCHAT VOCAL (PEERJS)
    const peer = new Peer(myId.replace(/\s+/g, '-'));
    const btnVocal = document.getElementById('btn-vocal');

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        myStream = stream;
        myStream.getAudioTracks()[0].enabled = false;
    }).catch(err => console.log("Audio non disponible"));

    btnVocal.onclick = () => {
        if(!myStream) return;
        const state = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !state;
        btnVocal.innerText = !state ? "Micro : ON" : "Micro : OFF";
        btnVocal.classList.toggle('on');
    };

    peer.on('call', call => {
        call.answer(myStream);
        call.on('stream', userStream => {
            const audio = document.createElement('audio');
            audio.srcObject = userStream; audio.play();
        });
    });

    // 3. FONCTIONS DE SYNC
    function updateDB() {
        if (!myCurrentPos) return;
        const safeId = myId.replace(/[.#$\[\]]/g, "_");
        if (isVisible) {
            db.ref('vehicles/' + safeId).set({
                lat: myCurrentPos.lat, lon: myCurrentPos.lon,
                active: isPEC, ts: Date.now()
            });
        } else {
            db.ref('vehicles/' + safeId).remove();
        }
    }

    // 4. ACTIONS BOUTONS
    document.getElementById('btn-signalement').onclick = function() {
        isVisible = !isVisible;
        this.classList.toggle('active');
        this.innerText = isVisible ? "VISIBLE" : "S'AFFICHER";
        updateDB();
    };

    document.getElementById('btn-prise-charge').onclick = function() {
        isPEC = !isPEC;
        this.classList.toggle('active');
        this.innerText = isPEC ? "EN INTERCEPTION" : "DÃ©marrer Prise en Charge";
        updateDB();
    };

    idInput.onchange = function() {
        db.ref('vehicles/' + myId.replace(/[.#$\[\]]/g, "_")).remove();
        myId = this.value;
        localStorage.setItem('unit_name', myId);
        updateDB();
    };

    // 5. RÃ‰CEPTION ET ALERTES GLOBALES
    db.ref('vehicles/').on('value', (snap) => {
        const data = snap.val() || {};
        const list = document.getElementById('unit-list');
        list.innerHTML = "";
        let pecGlobal = "";
        let collision = false;
        const safeMyId = myId.replace(/[.#$\[\]]/g, "_");

        // Nettoyer marqueurs
        for (let id in otherVehicles) {
            if (!data[id]) { map.removeLayer(otherVehicles[id]); delete otherVehicles[id]; }
        }

        for (let id in data) {
            const v = data[id];
            
            // VÃ©rifier si quelqu'un (soi ou un autre) est en prise en charge
            if (v.active) { pecGlobal = id.replace(/_/g, ' '); }

            if (id === safeMyId) continue;

            // Affichage des autres sur la carte
            if (!otherVehicles[id]) {
                otherVehicles[id] = L.marker([v.lat, v.lon]).addTo(map).bindPopup(id);
                peer.call(id.replace(/\s+/g, '-'), myStream); // Connexion vocale auto
            } else {
                otherVehicles[id].setLatLng([v.lat, v.lon]);
            }

            // Anti-collision
            if (myCurrentPos) {
                const R = 6371000;
                const dLat = (v.lat - myCurrentPos.lat) * Math.PI / 180;
                const dLon = (v.lon - myCurrentPos.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(v.lat*Math.PI/180)*Math.cos(myCurrentPos.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                if (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) < 50) collision = true;
            }

            const li = document.createElement('li');
            li.style.color = v.active ? '#e74c3c' : 'white';
            li.innerText = (v.active ? "ðŸš¨ " : "ðŸš” ") + id.replace(/_/g, ' ');
            list.appendChild(li);
        }

        // MISE Ã€ JOUR DU STATUT SUR TOUS LES APPAREILS
        if (pecGlobal !== "") {
            statusBadge.innerText = "ðŸš¨ PRISE EN CHARGE : " + pecGlobal;
            statusBadge.className = "status-badge danger-mode";
        } else if (collision) {
            statusBadge.innerText = "âš ï¸ PROXIMITÃ‰ CRITIQUE";
            statusBadge.className = "status-badge danger-mode";
            if(navigator.vibrate) navigator.vibrate(500);
        } else {
            statusBadge.innerText = "ZONE SÃ‰CURISÃ‰E";
            statusBadge.className = "status-badge";
        }
    });

    // 6. GEOLOCALISATION
    navigator.geolocation.watchPosition((p) => {
        myCurrentPos = { lat: p.coords.latitude, lon: p.coords.longitude };
        myMarker.setLatLng([myCurrentPos.lat, myCurrentPos.lon]);
        map.setView([myCurrentPos.lat, myCurrentPos.lon]);
        updateDB();
        db.ref('vehicles/' + myId.replace(/[.#$\[\]]/g, "_")).onDisconnect().remove();
    }, null, { enableHighAccuracy: true });

</script>
</body>
</html>
