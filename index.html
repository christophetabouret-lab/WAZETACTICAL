<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SystÃ¨me de Prise en Charge</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        #sidebar { 
            width: 100%; max-height: 45%; background: #2c2c2c; padding: 15px; 
            border-bottom: 2px solid #e74c3c; z-index: 1000; display: flex; 
            flex-direction: column; box-sizing: border-box; overflow-y: auto; 
        }
        #map { flex-grow: 1; width: 100%; background: #222; }
        .status-badge { 
            padding: 10px; border-radius: 4px; font-weight: bold; background: #27ae60; 
            text-align: center; margin-top: 10px; transition: background 0.3s; font-size: 0.9rem;
        }
        .danger-mode { background: #e74c3c !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #btn-signalement {
            background: #3498db; color: white; border: none; padding: 12px;
            font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px;
            text-transform: uppercase; font-size: 0.8rem;
        }
        #btn-signalement.active { background: #2980b9; box-shadow: inset 0 0 10px #000; border: 1px solid white; }

        #btn-prise-charge {
            background: #e67e22; color: white; border: none; padding: 12px;
            font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px;
            text-transform: uppercase; font-size: 0.8rem;
        }
        #btn-prise-charge.active { background: #c0392b; box-shadow: 0 0 15px #e74c3c; }
        
        #btn-vocal {
            background: #34495e; color: white; border: none; padding: 10px;
            margin-top: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 0.8rem;
        }
        #btn-vocal.on { background: #2ecc71; }
        
        h2 { color: #e74c3c; text-transform: uppercase; font-size: 1rem; margin: 0; }
        h3 { font-size: 0.9rem; color: #bdc3c7; margin: 10px 0 5px 0; }
        hr { border: 0; border-top: 1px solid #444; margin: 10px 0; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 5px 0; border-bottom: 1px solid #333; font-size: 0.8rem; }
        #unit-id-input {
            background: #444; border: 1px solid #666; color: white; padding: 8px;
            border-radius: 4px; width: 100%; margin-top: 5px; box-sizing: border-box; font-size: 0.9rem;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="sidebar">
        <h2>Suivi Prise en Charge</h2>
        <input type="text" id="unit-id-input" placeholder="Nom de l'UnitÃ©">
        <p style="margin: 5px 0; font-size: 0.9rem;"><strong>Vitesse :</strong> <span id="speed">0</span> km/h</p>
        <button id="btn-vocal">Micro : OFF</button>
        <button id="btn-signalement">S'afficher sur la carte</button>
        <button id="btn-prise-charge">DÃ©marrer Prise en Charge</button>
        <div id="main-status" class="status-badge">ZONE SÃ‰CURISÃ‰E</div>
        <hr>
        <h3>UnitÃ©s en service</h3>
        <ul id="unit-list"></ul>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://poursuite-tactique-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const idInput = document.getElementById('unit-id-input');
    let myId = localStorage.getItem('unit_name') || "UnitÃ©-" + Math.floor(Math.random() * 1000);
    idInput.value = myId;

    const map = L.map('map').setView([48.8566, 2.3522], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const otherVehicles = {};
    let myCurrentPos = null;
    let isActionActive = false;
    let isVisibleOnMap = false;
    let myStream;

    const peer = new Peer(myId.replace(/\s+/g, '-'));
    const btnVocal = document.getElementById('btn-vocal');
    const btnSignalement = document.getElementById('btn-signalement');
    const btnPriseCharge = document.getElementById('btn-prise-charge');
    const statusBadge = document.getElementById('main-status');

    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        myStream = stream;
        myStream.getAudioTracks()[0].enabled = false;
    }).catch(err => console.log("Micro en attente"));

    btnVocal.addEventListener('click', () => {
        if(!myStream) return;
        const state = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !state;
        btnVocal.innerText = !state ? "Micro : ON" : "Micro : OFF";
        btnVocal.classList.toggle('on');
    });

    peer.on('call', call => {
        call.answer(myStream);
        call.on('stream', userStream => {
            const audio = document.createElement('audio');
            audio.srcObject = userStream; audio.play();
        });
    });

    // IcÃ´nes personnalisÃ©es pour SOI-MÃŠME
    const iconNormal = L.divIcon({className: 'my-unit', html: 'ðŸš”', iconSize: [30, 30]});
    const iconActive = L.divIcon({className: 'my-unit', html: 'ðŸ”´', iconSize: [30, 30]});
    const myMarker = L.marker([0, 0], { zIndexOffset: 1000, icon: iconNormal }).addTo(map).bindPopup("MOI");
    const safetyZone = L.circle([0, 0], { color: '#3498db', radius: 100 }).addTo(map);

    function updatePosition(lat, lon, speed) {
        const safeId = myId.replace(/[.#$\[\]]/g, "_");
        if (isVisibleOnMap) {
            db.ref('vehicles/' + safeId).set({ lat, lon, speed, active: isActionActive, timestamp: Date.now() });
        } else {
            db.ref('vehicles/' + safeId).remove();
        }
    }

    btnSignalement.addEventListener('click', function() {
        isVisibleOnMap = !isVisibleOnMap;
        this.classList.toggle('active');
        this.innerText = isVisibleOnMap ? "Signalement : ACTIF" : "S'afficher sur la carte";
        if(myCurrentPos) updatePosition(myCurrentPos.lat, myCurrentPos.lon, document.getElementById('speed').innerText);
    });

    btnPriseCharge.addEventListener('click', function() {
        isActionActive = !isActionActive;
        this.classList.toggle('active');
        this.innerText = isActionActive ? "En cours de Prise en Charge" : "DÃ©marrer Prise en Charge";
        
        // NOTIFICATION VISUELLE IMMEDIATE POUR L'INTERVENANT
        if(isActionActive) {
            statusBadge.innerText = "ðŸš¨ PRISE EN CHARGE ACTIVE";
            statusBadge.classList.add('danger-mode');
            myMarker.setIcon(iconActive); // Devient rouge sur sa propre carte
        } else {
            statusBadge.innerText = "ZONE SÃ‰CURISÃ‰E";
            statusBadge.classList.remove('danger-mode');
            myMarker.setIcon(iconNormal); // Repasse en bleu/normal
        }
        
        if(myCurrentPos) updatePosition(myCurrentPos.lat, myCurrentPos.lon, document.getElementById('speed').innerText);
    });

    idInput.addEventListener('change', () => {
        const oldId = myId.replace(/[.#$\[\]]/g, "_");
        myId = idInput.value.trim() || "Anonyme";
        localStorage.setItem('unit_name', myId);
        db.ref('vehicles/' + oldId).remove();
        if(myCurrentPos) updatePosition(myCurrentPos.lat, myCurrentPos.lon, document.getElementById('speed').innerText);
    });

    db.ref('vehicles/').on('value', (snapshot) => {
        const data = snapshot.val();
        const unitList = document.getElementById('unit-list');
        unitList.innerHTML = ""; 
        let proximityAlert = false;

        for (let id in data) {
            if (id === myId.replace(/[.#$\[\]]/g, "_")) continue;
            
            const { lat, lon, speed, active } = data[id];
            const iconMarker = active ? 'ðŸ”´' : 'ðŸš”';
            
            if (!otherVehicles[id]) {
                otherVehicles[id] = L.marker([lat, lon], {
                    icon: L.divIcon({className: 'other-unit', html: iconMarker, iconSize: [25, 25]})
                }).addTo(map).bindPopup(id);
            } else {
                otherVehicles[id].setLatLng([lat, lon]);
                otherVehicles[id].setIcon(L.divIcon({className: 'other-unit', html: iconMarker, iconSize: [25, 25]}));
            }

            if (myCurrentPos) {
                const R = 6371e3;
                const a = Math.sin(((lat-myCurrentPos.lat)*Math.PI/180)/2)**2 + Math.cos(myCurrentPos.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(((lon-myCurrentPos.lon)*Math.PI/180)/2)**2;
                const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                if (dist < 100) proximityAlert = true;
            }

            const li = document.createElement('li');
            li.style.color = active ? '#e74c3c' : 'white';
            li.innerText = `${id} - ${speed} km/h ${active ? '(ACTIF)' : ''}`;
            unitList.appendChild(li);
        }

        // Si une AUTRE unitÃ© est en danger Ã  cÃ´tÃ© de moi
        if (proximityAlert && !isActionActive) {
            statusBadge.innerText = "âš ï¸ PROXIMITÃ‰ CRITIQUE";
            statusBadge.classList.add('danger-mode');
        }
    });

    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const speed = position.coords.speed ? Math.round(position.coords.speed * 3.6) : 0;
            myCurrentPos = { lat, lon };
            myMarker.setLatLng([lat, lon]); 
            safetyZone.setLatLng([lat, lon]); 
            map.setView([lat, lon]);
            document.getElementById('speed').innerText = speed;
            updatePosition(lat, lon, speed);
        }, null, { enableHighAccuracy: true });
    }
</script>
</body>
</html>
