<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYST√àME TACTIQUE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        #sidebar { background: #2c2c2c; padding: 10px; border-bottom: 3px solid #e74c3c; z-index: 1000; }
        #map { height: calc(100vh - 160px); width: 100%; background: #222; }
        
        /* BANDEAU DE NOTIFICATION SURVITAMIN√â */
        .status-badge { 
            padding: 12px; border-radius: 4px; font-weight: bold; background: #27ae60; 
            text-align: center; margin-top: 10px; font-size: 1.1rem; border: 2px solid transparent;
        }
        
        .danger-mode { 
            background: #ff0000 !important; 
            animation: flash-critique 0.4s steps(2) infinite; 
            border: 3px solid #ffffff !important;
            color: white !important;
            box-shadow: 0 0 20px #ff0000;
        }
        @keyframes flash-critique { 0% { background: #ff0000; } 100% { background: #000000; } }
        
        button { width: 100%; padding: 12px; margin-top: 5px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; }
        #btn-vocal { background: #34495e; }
        #btn-vocal.on { background: #2ecc71; }
        #btn-signal { background: #3498db; }
        #btn-signal.active { background: #2ecc71; }
        #btn-pec { background: #e67e22; }
        #btn-pec.active { background: #c0392b; }
        
        input { width: 100%; padding: 10px; background: #444; border: 1px solid #666; color: white; border-radius: 4px; margin-bottom: 5px; box-sizing: border-box; }
        #unit-list { list-style: none; padding: 0; margin: 5px 0; max-height: 50px; overflow-y: auto; font-size: 0.8rem; background: #111; border-radius: 4px; }
        li { padding: 3px 8px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="sidebar">
    <input type="text" id="unit-id" placeholder="NOM DE L'UNIT√â">
    <div style="display: flex; gap: 5px;">
        <button id="btn-vocal">üéôÔ∏è VOCAL : OFF</button>
        <button id="btn-signal">üì° S'AFFICHER</button>
    </div>
    <button id="btn-pec">üö® D√âMARRER PRISE EN CHARGE</button>
    <div id="main-status" class="status-badge">ZONE S√âCURIS√âE</div>
    <ul id="unit-list"></ul>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    // --- INITIALISATION ---
    const firebaseConfig = { databaseURL: "https://poursuite-tactique-default-rtdb.europe-west1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const idInput = document.getElementById('unit-id');
    let myId = localStorage.getItem('unit_name') || "U-" + Math.floor(Math.random() * 999);
    idInput.value = myId;

    const map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let myPos = null;
    let isVisible = false;
    let isPEC = false;
    let myStream = null;
    const otherMarkers = {};
    const myMarker = L.marker([0, 0], { zIndexOffset: 2000 }).addTo(map).bindPopup("MOI");
    const statusBadge = document.getElementById('main-status');

    // --- TCHAT VOCAL ---
    const peer = new Peer(myId.replace(/\s+/g, '-'));
    navigator.mediaDevices.getUserMedia({ audio: true }).then(st => { myStream = st; myStream.getAudioTracks()[0].enabled = false; });
    
    document.getElementById('btn-vocal').onclick = function() {
        if(!myStream) return;
        const active = myStream.getAudioTracks()[0].enabled;
        myStream.getAudioTracks()[0].enabled = !active;
        this.innerText = !active ? "üéôÔ∏è VOCAL : ON" : "üéôÔ∏è VOCAL : OFF";
        this.classList.toggle('on');
    };

    peer.on('call', call => {
        call.answer(myStream);
        call.on('stream', st => { const audio = new Audio(); audio.srcObject = st; audio.play(); });
    });

    // --- MISE √Ä JOUR BASE ---
    function send() {
        if (!myPos) return;
        const safeId = myId.replace(/[.#$\[\]]/g, "_");
        if (isVisible) {
            db.ref('vehicles/' + safeId).set({ lat: myPos.lat, lon: myPos.lon, active: isPEC, ts: Date.now() });
        } else {
            db.ref('vehicles/' + safeId).remove();
        }
    }

    document.getElementById('btn-signal').onclick = function() {
        isVisible = !isVisible;
        this.classList.toggle('active');
        this.innerText = isVisible ? "üì° VISIBLE" : "üì° S'AFFICHER";
        send();
    };

    document.getElementById('btn-pec').onclick = function() {
        isPEC = !isPEC;
        this.classList.toggle('active');
        this.innerText = isPEC ? "üõë STOP INTERCEPTION" : "üö® D√âMARRER PRISE EN CHARGE";
        send();
    };

    idInput.onchange = function() {
        db.ref('vehicles/' + myId.replace(/[.#$\[\]]/g, "_")).remove();
        myId = this.value;
        localStorage.setItem('unit_name', myId);
        send();
    };

    // --- LE C≈íUR : √âCOUTEUR DE NOTIFICATION ET POSITIONS ---
    db.ref('vehicles/').on('value', (snap) => {
        const data = snap.val() || {};
        const list = document.getElementById('unit-list');
        list.innerHTML = "";
        
        let pecActiveId = null;
        let collisionAlert = false;
        const safeMyId = myId.replace(/[.#$\[\]]/g, "_");

        // G√©rer les marqueurs
        for (let id in otherMarkers) { if (!data[id]) { map.removeLayer(otherMarkers[id]); delete otherMarkers[id]; } }

        for (let id in data) {
            const v = data[id];
            
            // VERIFICATION CRITIQUE POUR LA NOTIFICATION
            if (v.active === true) { pecActiveId = id.replace(/_/g, ' '); }

            if (id === safeMyId) continue;

            // Dessin Map
            if (!otherMarkers[id]) {
                otherMarkers[id] = L.marker([v.lat, v.lon]).addTo(map).bindPopup(id);
                if (myStream) peer.call(id.replace(/\s+/g, '-'), myStream);
            } else {
                otherMarkers[id].setLatLng([v.lat, v.lon]);
            }

            // Anti-collision < 50m
            if (myPos) {
                const dist = L.latLng(myPos.lat, myPos.lon).distanceTo(L.latLng(v.lat, v.lon));
                if (dist < 50) collisionAlert = true;
            }

            const li = document.createElement('li');
            li.style.color = v.active ? '#ff4444' : '#3498db';
            li.innerText = (v.active ? "üî¥ " : "üöî ") + id.replace(/_/g, ' ');
            list.appendChild(li);
        }

        // --- AFFICHAGE DE LA NOTIFICATION SUR TOUS LES √âCRANS ---
        if (pecActiveId) {
            statusBadge.innerText = "üö® ALERTE : " + pecActiveId.toUpperCase() + " EN INTERCEPTION";
            statusBadge.classList.add('danger-mode');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        } else if (collisionAlert) {
            statusBadge.innerText = "‚ö†Ô∏è DANGER : COLLISION PROCHE";
            statusBadge.classList.add('danger-mode');
        } else {
            statusBadge.innerText = "ZONE S√âCURIS√âE";
            statusBadge.classList.remove('danger-mode');
        }
    });

    // --- GPS ---
    navigator.geolocation.watchPosition((p) => {
        myPos = { lat: p.coords.latitude, lon: p.coords.longitude };
        myMarker.setLatLng([myPos.lat, myPos.lon]);
        if (!map.getBounds().contains(myMarker.getLatLng())) map.panTo([myPos.lat, myPos.lon]);
        send();
        db.ref('vehicles/' + myId.replace(/[.#$\[\]]/g, "_")).onDisconnect().remove();
    }, null, { enableHighAccuracy: true });

</script>
</body>
</html>
